# Derecho-stats-MOM6-examples
A repository for managing regression answers for MOM6 on Derecho

## Basics rules
1. This repository contains Derecho regression answers only. Other platforms should have their own repository. Only Intel is supported at the moment.
3. Commits are only made when the regression answers change.
4. MOM6-examples is a sub-module of this repository. When regression answers change the new commit of the sub-module must be added with the changed answers.
5. Regression answers have a suffix which is a label usually referring to a compiler name. These labels are listed in _labels.json_.

This repository follows the [Gaea stats framework](https://github.com/adcroft/Gaea-stats-MOM6-examples) and [MOM6 regression stats](https://github.com/NOAA-GFDL/MOM6-examples/tree/main/tools/MRS)

***

## Clone this repo on Derecho

git clone --recursive git@github.com:NCAR/Derecho-stats-MOM6-examples.git

### Copy missing src codes, updated mkmf, and link datasets
```bash
cd Derecho-stats-MOM6-examples/MOM6-examples/src
src_code='/glade/work/gmarques/Derecho-stats-MOM6-examples/MOM6-examples/src'
rm -rf mkmf
cp -r $src_code/mkmf .
cp -r $src_code/LM3 .
cp -r $src_code/atmos_param_am3 .
cp -r $src_code/AM2 .
cp -r $src_code/sis1 .
cd ../
ln -s /glade/work/gmarques/GFDL_datasets/ .datasets
```
## Generate manifest
`MRS/generate_manifest.sh > manifest.mk`

***
## Build

Get a batch node

`qinteractive`

then execure the following:

`make -f MRS/Makefile.build build_intel -j -s`

***

## Run

First, request enough processors (at least 576):

`qsub -I -l select=16:ncpus=36:mpiprocs=36 -l walltime=01:00:00 -q main -A P93300012`

Then, execure th following:

`make -f MRS/Makefile.run intel_all MEMORY=dynamic_symmetric LOG=`

***
## Sync

On the loging node, execure the following:

`make -f MRS/Makefile.sync intel`

***

## Workflow for when regression answers change
1. Copy regression answers generated by MOM6 into the corresponding directory under regressions.
2. Stage any changed regressions and also add the MOM6-examples sub-module commit.
3. Commit.
4. Push (if sharing with other developers)

For example:
```bash
### Copy files
foreach compiler (gnu intel pgi)
  foreach file (`cd MOM6-examples ; find * -name ocean.stats.$compiler -o -name seaice.stats.$compiler`)
    mkdir -p regressions/$file:h
    \cp MOM6-examples/$file regressions/$file
  end
end

git add regressions
git add MOM6-examples
git commit
```

